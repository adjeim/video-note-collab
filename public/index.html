<html>
  <head>
    <meta name='viewport' content='width=device-width, initial-scale=1.0' />
    <link href='https://unpkg.com/tailwindcss@^2/dist/tailwind.min.css' rel='stylesheet'>
    <script type="text/javascript" src="https://media.twiliocdn.com/sdk/js/sync/v2.0/twilio-sync.min.js"></script>
    <title>Video Collaboration with Notes</title>
  </head>
  <body class='bg-grey-100 p-10 flex'>
    <textarea id='notepad' class='h-44 w-full shadow-lg border rounded-md p-3 sm:mx-auto sm:w-1/2'></textarea>

    <script>
      const notepad = document.getElementById('notepad');
      let twilioSyncClient;

      fetch('/token')
        .then(response => response.json())
        .then(data => {

          let token = data.token;
          let syncClient = new Twilio.Sync.Client(token);

          twilioSyncClient = syncClient;

          twilioSyncClient.document('notepad')
            .then(function(document) {

              // Load the existing Document
              notepad.value = document.data.content;

              // Listen to updates on the Document
              document.on('updated', function(event) {

                // Update the cursor position
                let cursorStartPos = notepad.selectionStart;
                let cursorEndPos = notepad.selectionEnd;

                // Set the notepad content to the synced Document
                notepad.value = event.data.content;

                // Reset the cursor position
                notepad.selectionEnd = cursorEndPos;

                console.log('Received Document update event. New value:', event.data.content);
              })
            })
            .catch(function(error) {
              console.error('Unexpected error', error);
            });
        })

      const syncNotepad = (syncClient) => {
        const notepadContent = notepad.value;
        twilioSyncClient.document('notepad').then((doc) => {
          doc.update({ content: notepadContent });
        })
      }

      // Add listener
      notepad.addEventListener('keyup', (event) => {

        // Define array of triggers to sync (space, enter, and punctuation)
        // Otherwise sync will fire every time
        const syncKeys = [32, 13, 8, 188, 190];

        if (syncKeys.includes(event.keyCode)) {
          syncNotepad(twilioSyncClient);
        }
      })
    </script>
  </body>
</html>